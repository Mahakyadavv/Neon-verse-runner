<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Neon-Verse: Ultimate Run</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
  </head>
  <body>
    <script>
      // GLOBAL VARIABLES
      let isRunning = true;
      let score = 0;
      let gameSpeed = 0.15; 

      AFRAME.registerComponent('game-manager', {
        init: function () {
          this.scoreEl = document.querySelector('#score-text');
          this.gameOverEl = document.querySelector('#game-over-text');
          this.timer = 0;
          // Game start hone ke 2 second tak collision off rakhenge (Safety)
          this.warmupTime = 0; 
        },
        
        tick: function (time, timeDelta) {
          if (!isRunning) return;

          this.warmupTime += timeDelta;

          // 1. Update Score (Har frame badhega)
          score++;
          // Har 10 frame pe text update karo taaki load kam pade
          if(score % 10 === 0) { 
             this.scoreEl.setAttribute('value', 'SCORE: ' + Math.floor(score / 10));
          }

          // 2. Spawn Obstacles
          this.timer += timeDelta;
          if (this.timer > 1500) { // Har 1.5 second mein naya obstacle
            this.spawnObstacle();
            this.timer = 0;
          }

          // 3. Check Collisions (Sirf warmup ke baad)
          if (this.warmupTime > 2000) {
              this.checkCollision();
          }
        },

        spawnObstacle: function() {
          const scene = this.el.sceneEl;
          const entity = document.createElement('a-box');
          
          // Position: Left(-2), Center(0), Right(2)
          const lane = Math.floor(Math.random() * 3) - 1; 
          const xPos = lane * 2; 

          // Door spawn karo (Z = -50)
          entity.setAttribute('position', {x: xPos, y: 1, z: -50}); 
          entity.setAttribute('width', 1.5);
          entity.setAttribute('height', 2);
          entity.setAttribute('depth', 1.5);
          entity.setAttribute('material', {
            color: Math.random() > 0.5 ? '#ff0055' : '#00ccff', 
            opacity: 0.8, 
            transparent: true
          });
          
          // Wireframe Glow border
          const wireframe = document.createElement('a-box');
          wireframe.setAttribute('material', 'wireframe: true; color: white');
          wireframe.setAttribute('width', 1.6);
          wireframe.setAttribute('height', 2.1);
          wireframe.setAttribute('depth', 1.6);
          entity.appendChild(wireframe);

          entity.setAttribute('mover', '');
          entity.classList.add('obstacle');
          
          scene.appendChild(entity);
        },

        checkCollision: function() {
          const player = document.querySelector('#camera');
          const playerPos = player.object3D.position; 
          const obstacles = document.querySelectorAll('.obstacle');

          obstacles.forEach(obs => {
            const obsPos = obs.object3D.position;
            
            // --- CRITICAL FIX ---
            // Agar obstacle door hai (z < -3), toh ignore karo.
            // Ye "Ghost Collision" hone hi nahi dega.
            if (obsPos.z < -3) return; 
            // --------------------

            // Agar obstacle player ke paas hai (Z axis)
            if (obsPos.z > -1.5 && obsPos.z < 1.5) {
              // Aur agar same lane mein hai (X axis)
              if (Math.abs(obsPos.x - playerPos.x) < 0.8) {
                this.gameOver();
              }
            }
          });
        },

        gameOver: function() {
          isRunning = false;
          this.gameOverEl.setAttribute('visible', true);
          this.scoreEl.setAttribute('color', 'red');
          // 2 sec baad reload
          setTimeout(() => location.reload(), 2500);
        }
      });

      // Mover Component (Isme smooth movement hai)
      AFRAME.registerComponent('mover', {
        tick: function (time, timeDelta) {
          if (!isRunning) return;
          const currentPos = this.el.getAttribute('position');
          // Movement formula independent of frame rate
          currentPos.z += gameSpeed * (timeDelta / 16); 
          this.el.setAttribute('position', currentPos);

          if (currentPos.z > 5) {
            this.el.parentNode.removeChild(this.el);
          }
        }
      });
    </script>

    <a-scene game-manager background="color: #000">
      
      <a-entity environment="preset: tron; grid: 1x1; gridColor: #222; groundColor: #111; skyType: atmosphere;"></a-entity>

      <a-entity id="rig" position="0 0 0">
        <a-camera id="camera" position="0 1.6 0" look-controls wasd-controls>
          <a-text id="score-text" value="SCORE: 0" position="-0.8 0.8 -1.5" color="#fff" width="4"></a-text>
          <a-text id="game-over-text" visible="false" value="CRASHED!\nRetrying..." position="-0.9 0 -1.5" color="#ff0000" width="6"></a-text>
        </a-camera>
        <a-entity laser-controls="hand: left"></a-entity>
        <a-entity laser-controls="hand: right"></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
